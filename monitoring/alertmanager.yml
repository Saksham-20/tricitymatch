# Alertmanager Configuration for TricityMatch
# Configure alert routing and notification channels

global:
  # How long to wait before sending a notification again for same alert
  resolve_timeout: 5m
  
  # SMTP configuration for email alerts
  # smtp_smarthost: 'smtp.gmail.com:587'
  # smtp_from: 'alerts@tricitymatch.com'
  # smtp_auth_username: 'alerts@tricitymatch.com'
  # smtp_auth_password: '{{ .SMTP_PASSWORD }}'
  
  # Slack configuration
  # slack_api_url: '{{ .SLACK_WEBHOOK_URL }}'

# Alert routing tree
route:
  # Default receiver
  receiver: 'default-receiver'
  
  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'service']
  
  # How long to wait before sending first notification
  group_wait: 30s
  
  # How long to wait before sending notification about new alerts in group
  group_interval: 5m
  
  # How long to wait before resending notification
  repeat_interval: 4h
  
  # Child routes
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      repeat_interval: 1h
      continue: true
    
    # Security alerts - separate channel
    - match:
        service: security
      receiver: 'security-alerts'
      continue: true
    
    # Database alerts
    - match:
        service: database
      receiver: 'database-alerts'
    
    # Application alerts
    - match:
        service: api
      receiver: 'app-alerts'

# Inhibition rules to prevent alert storms
inhibit_rules:
  # If critical alert is firing, suppress warning for same alertname
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']
  
  # If InstanceDown fires, suppress other alerts for that instance
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: '.+'
    equal: ['instance']

# Receivers define where/how to send alerts
receivers:
  # Default receiver - logs only (configure based on your setup)
  - name: 'default-receiver'
    # webhook_configs:
    #   - url: 'http://localhost:5000/api/webhooks/alerts'

  # Critical alerts receiver
  - name: 'critical-alerts'
    # Email configuration
    # email_configs:
    #   - to: 'oncall@tricitymatch.com'
    #     send_resolved: true
    #     headers:
    #       Subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
    
    # Slack configuration
    # slack_configs:
    #   - channel: '#alerts-critical'
    #     send_resolved: true
    #     title: '{{ if eq .Status "firing" }}üö®{{ else }}‚úÖ{{ end }} {{ .CommonLabels.alertname }}'
    #     text: >-
    #       {{ range .Alerts }}
    #       *Alert:* {{ .Annotations.summary }}
    #       *Description:* {{ .Annotations.description }}
    #       *Severity:* {{ .Labels.severity }}
    #       {{ if .Annotations.runbook }}*Runbook:* {{ .Annotations.runbook }}{{ end }}
    #       {{ end }}
    
    # PagerDuty configuration
    # pagerduty_configs:
    #   - service_key: '{{ .PAGERDUTY_KEY }}'

  # Security alerts receiver
  - name: 'security-alerts'
    # slack_configs:
    #   - channel: '#security-alerts'
    #     send_resolved: true
    #     title: 'üîê Security Alert: {{ .CommonLabels.alertname }}'

  # Database alerts receiver
  - name: 'database-alerts'
    # slack_configs:
    #   - channel: '#database-alerts'
    #     send_resolved: true

  # Application alerts receiver
  - name: 'app-alerts'
    # slack_configs:
    #   - channel: '#app-alerts'
    #     send_resolved: true

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'
